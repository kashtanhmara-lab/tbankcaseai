# openai_assistant.py
from typing import Dict, List, Optional, Tuple
import json
from datetime import datetime

try:
    import openai
    OPENAI_AVAILABLE = True
except ImportError:
    OPENAI_AVAILABLE = False
    print("‚ö†Ô∏è –ú–æ–¥—É–ª—å openai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install openai")

class OpenAIAssistant:
    def __init__(self, api_key: str, auth_system=None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –ø–æ–º–æ—â–Ω–∏–∫–∞
        
        Args:
            api_key: API –∫–ª—é—á –æ—Ç OpenAI
            auth_system: –°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        """
        self.auth_system = auth_system
        self.api_key = api_key
        self.is_initialized = False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –º–æ–¥—É–ª—å openai
        if not OPENAI_AVAILABLE:
            print("‚ùå –ú–æ–¥—É–ª—å openai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. AI –ø–æ–º–æ—â–Ω–∏–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.")
            self.test_mode = True
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á
        if not api_key or api_key.strip() == "" or api_key == "your-api-key-here":
            print("‚ö†Ô∏è API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. AI –ø–æ–º–æ—â–Ω–∏–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.")
            self.test_mode = True
            return
        
        try:
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç OpenAI (–¥–ª—è –≤–µ—Ä—Å–∏–∏ 1.x –∏ –≤—ã—à–µ)
            if hasattr(openai, 'OpenAI'):
                self.client = openai.OpenAI(api_key=api_key)
                self.api_version = "v1+"
            else:
                # –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π (0.28 –∏ –Ω–∏–∂–µ)
                openai.api_key = api_key
                self.client = None
                self.api_version = "v0"
            
            self.test_mode = False
            self.is_initialized = True
            print("‚úÖ OpenAI –ø–æ–º–æ—â–Ω–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI: {e}")
            self.test_mode = True
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–º–∞—Ç–∏–∫–∏
        self.system_prompt = """–¢—ã - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–∫—É–ø–∫–∞–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ MindGuard.
        –¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö, –±—é–¥–∂–µ—Ç–µ, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö.
        
        –¢–ï–ú–ê–¢–ò–ö–ò –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø:
        1. –ü–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —É—Å–ª—É–≥
        2. –ë—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤
        3. –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è
        4. –ö—Ä–µ–¥–∏—Ç—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∏, –∏–ø–æ—Ç–µ–∫–∞
        5. –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã)
        6. –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        7. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ü–µ–Ω
        8. –≠–∫–æ–Ω–æ–º–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
        9. –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—É–ø–æ–∫ (—Å—Ç–æ–∏—Ç –ª–∏ –ø–æ–∫—É–ø–∞—Ç—å, –∫–æ–≥–¥–∞ –ø–æ–∫—É–ø–∞—Ç—å)
        10. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏
        
        –ó–ê–ü–†–ï–©–ï–ù–ù–´–ï –¢–ï–ú–´:
        - –ü–æ–ª–∏—Ç–∏–∫–∞
        - –ú–µ–¥–∏—Ü–∏–Ω–∞ –∏ –∑–¥–æ—Ä–æ–≤—å–µ (–∫—Ä–æ–º–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ª–µ—á–µ–Ω–∏—è)
        - –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
        - –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        - –õ–∏—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
        - –†–µ–ª–∏–≥–∏—è
        - –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ –∏ –ø–æ–∫—É–ø–∫–∞–º–∏
        
        –ï–°–õ–ò –í–û–ü–†–û–° –ù–ï –ü–û –¢–ï–ú–ï:
        –í–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –ø–æ–∫—É–ø–∫–∞–º–∏.
        –ü—Ä–∏–º–µ—Ä: "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö."
        
        –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
        - –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
        - –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
        - –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–¥–∞—É–Ω –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        - –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
        - –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–æ–≤–µ—Ç—ã –ø–æ–¥ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        
        # –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.conversation_history = {}
        
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–∞–º—è—Ç—å)
        self.max_history_messages = 10
        
        # –ú–æ–¥–µ–ª—å GPT (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ gpt-4 –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø)
        self.model = "gpt-3.5-turbo"
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        self.temperature = 0.7
        self.max_tokens = 800
    
    def get_user_context(self, username: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤"""
        if not self.auth_system:
            return ""
        
        try:
            user_data = self.auth_system.get_user_data(username)
            if not user_data:
                return ""
            
            context_parts = []
            
            # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
            profile = user_data.get("personal_profile", {})
            monthly_income = profile.get("monthly_income", 0)
            savings_per_month = profile.get("savings_per_month", 0)
            current_savings = profile.get("current_savings", 0)
            
            if monthly_income > 0:
                context_parts.append(f"–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥: {monthly_income:,} ‚ÇΩ".replace(",", " "))
            
            if savings_per_month > 0:
                context_parts.append(f"–û—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≤ –º–µ—Å—è—Ü: {savings_per_month:,} ‚ÇΩ".replace(",", " "))
            
            if current_savings > 0:
                context_parts.append(f"–¢–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è: {current_savings:,} ‚ÇΩ".replace(",", " "))
            
            # –ü–æ–∫—É–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            purchases = user_data.get("purchases", [])
            if purchases:
                cooling_count = len([p for p in purchases if p.get("status") == "cooling"])
                purchased_count = len([p for p in purchases if p.get("status") == "purchased"])
                total_spent = sum(p.get("price", 0) for p in purchases if p.get("status") == "purchased")
                
                context_parts.append(f"–ü–æ–∫—É–ø–æ–∫ –Ω–∞ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏–∏: {cooling_count}")
                context_parts.append(f"–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫: {purchased_count}")
                context_parts.append(f"–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {total_spent:,} ‚ÇΩ".replace(",", " "))
                
                # –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                categories = {}
                for purchase in purchases:
                    category = purchase.get("category", "–î—Ä—É–≥–æ–µ")
                    categories[category] = categories.get(category, 0) + 1
                
                if categories:
                    top_categories = sorted(categories.items(), key=lambda x: x[1], reverse=True)[:3]
                    category_text = "–ß–∞—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + ", ".join([f"{cat} ({count})" for cat, count in top_categories])
                    context_parts.append(category_text)
            
            # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            forbidden = user_data.get("forbidden_categories", [])
            if forbidden:
                context_parts.append(f"–ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {', '.join(forbidden[:5])}")
            
            if context_parts:
                return "–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- " + "\n- ".join(context_parts)
            return ""
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
            return ""
    
    def validate_finance_question(self, question: str) -> Tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º/–ø–æ–∫—É–ø–∫–∞–º"""
        question_lower = question.lower().strip()
        
        # –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π
        if len(question_lower) < 3:
            return False, "–í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π"
        
        # –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Ç–µ–º
        blacklist_keywords = [
            '–ø–æ–ª–∏—Ç–∏–∫', '–≤–æ–π–Ω', '–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç', '–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤', '–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤',
            '–º–µ–¥–∏—Ü–∏–Ω', '–±–æ–ª–µ–∑–Ω', '–ª–µ—á–µ–Ω', '–≤—Ä–∞—á', '–±–æ–ª—å–Ω–∏', '–∑–¥–æ—Ä–æ–≤—å–µ',
            '—é—Ä–∏—Å—Ç', '—Å—É–¥', '–∑–∞–∫–æ–Ω', '–ø—Ä–∞–≤–æ', '–∞–¥–≤–æ–∫–∞—Ç',
            '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä', '–∫–æ–¥', 'python', '—Ä–∞–∑—Ä–∞–±–æ—Ç–∫', '–±–∞–≥', '–æ—à–∏–±–∫',
            '–æ—Ç–Ω–æ—à–µ–Ω', '–ª—é–±–æ–≤', '—Å–µ–º—å', '–¥—Ä—É–≥', '–ø–∞—Ä–µ–Ω—å', '–¥–µ–≤—É—à–∫', '–±—Ä–∞–∫',
            '—Ä–µ–ª–∏–≥–∏', '–±–æ–≥', '—Ü–µ—Ä–∫–æ–≤', '–≤–µ—Ä–∞',
            '–ø–æ–≥–æ–¥', '–∫–ª–∏–º–∞—Ç', '–ø—Ä–∏—Ä–æ–¥',
            '—Å–ø–æ—Ä—Ç', '—Ñ—É—Ç–±–æ–ª', '—Ö–æ–∫–∫–µ', '—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω',
            '–∫–∏–Ω–æ', '—Ñ–∏–ª—å–º', '—Å–µ—Ä–∏–∞–ª', '–∞–∫—Ç–µ—Ä',
            '–º—É–∑—ã–∫', '–ø–µ—Å–Ω', '–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å'
        ]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
        for keyword in blacklist_keywords:
            if keyword in question_lower:
                return False, f"–¢–µ–º–∞ '{keyword}' –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º"
        
        # –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Ç–µ–º
        whitelist_keywords = [
            # –î–µ–Ω—å–≥–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã
            '–¥–µ–Ω—å–≥', '—Ñ–∏–Ω–∞–Ω—Å', '–±—é–¥–∂–µ—Ç', '—ç–∫–æ–Ω–æ–º–∏', '—Ç—Ä–∞—Ç', '—Ä–∞—Å—Ö–æ–¥',
            '–¥–æ—Ö–æ–¥', '–∑–∞—Ä–∞–±–æ—Ç', '–ø–ª–∞—Ç', '—Å—Ç–æ–∏–º–æ—Å—Ç', '—Ü–µ–Ω–∞', '—Ü–µ–Ω', '—Å—Ç–æ–∏—Ç',
            '–∫—É–ø', '–ø–æ–∫—É–ø', '–ø—Ä–∏–æ–±—Ä–µ—Ç', '–∫—É–ø–∏—Ç', '–ø—Ä–æ–¥–∞', '–∑–∞–∫–∞–∑', '–æ–ø–ª–∞—Ç',
            '—Ç–æ–≤–∞—Ä', '–ø—Ä–æ–¥—É–∫—Ç', '—É—Å–ª—É–≥', '–º–∞–≥–∞–∑–∏–Ω', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω',
            
            # –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
            '–Ω–∞–∫–æ–ø', '—Å–±–µ—Ä–µ–∂–µ–Ω', '–∏–Ω–≤–µ—Å—Ç', '–≤–ª–æ–∂', '–∞–∫—Ü–∏', '–æ–±–ª–∏–≥–∞—Ü',
            '–¥–µ–ø–æ–∑–∏—Ç', '–≤–∫–ª–∞–¥', '—Å—á–µ—Ç', '–±–∞–Ω–∫', '–ø—Ä–æ—Ü–µ–Ω—Ç', '–≤—ã–≥–æ–¥',
            
            # –ö—Ä–µ–¥–∏—Ç—ã –∏ –∑–∞–π–º—ã
            '–∫—Ä–µ–¥–∏—Ç', '–∑–∞–µ–º', '–∏–ø–æ—Ç–µ–∫', '—Ä–∞—Å—Å—Ä–æ—á–∫', '–ø–ª–∞—Ç–µ–∂', '–¥–æ–ª–≥',
            '–ø—Ä–æ—Ü–µ–Ω—Ç–Ω', '—Å—Ç–∞–≤–∫', '–ø–æ–≥–∞—à–µ–Ω',
            
            # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            '—Ç–µ–ª–µ—Ñ–æ–Ω', '—Å–º–∞—Ä—Ç—Ñ–æ–Ω', '–∞–π—Ñ–æ–Ω', '–Ω–æ—É—Ç–±—É–∫', '–∫–æ–º–ø—å—é—Ç–µ—Ä',
            '—Ç–µ–ª–µ–≤–∏–∑–æ—Ä', '—Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫', '—Å—Ç–∏—Ä–∞–ª—å–Ω', '–∞–≤—Ç–æ–º–æ–±–∏–ª—å',
            '–º–∞—à–∏–Ω–∞', '–∫–≤–∞—Ä—Ç–∏—Ä', '–¥–æ–º', '–æ–¥–µ–∂–¥', '–æ–±—É–≤', '—Ç–µ—Ö–Ω–∏–∫',
            '–º–µ–±–µ–ª—å', '–±—ã—Ç–æ–≤', '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫',
            
            # –í–æ–ø—Ä–æ—Å—ã –∏ —Å–æ–≤–µ—Ç—ã
            '—Å–æ–≤–µ—Ç', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü', '–ø–æ–º–æ—â', '–ø–æ–º–æ–≥', '–∫–∞–∫', '—á—Ç–æ', '–≥–¥–µ',
            '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '—Å—Ç–æ–∏—Ç –ª–∏', '–ª—É—á—à–µ', '—Ö—É–∂–µ',
            '–¥–µ—à–µ–≤–ª', '–¥–æ—Ä–æ–≥', '—Å–∫–∏–¥–∫', '–∞–∫—Ü–∏', '—Ä–∞—Å–ø—Ä–æ–¥–∞–∂'
        ]
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
        for keyword in whitelist_keywords:
            if keyword in question_lower:
                return True, ""
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤–æ–ø—Ä–æ—Å–∞
        question_words = question_lower.split()
        question_starters = ['—Å–∫–æ–ª—å–∫–æ', '–∫–∞–∫', '—á—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞', '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '—Å—Ç–æ–∏—Ç']
        
        if question_words and question_words[0] in question_starters:
            return True, ""
        
        return False, "–í–æ–ø—Ä–æ—Å –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º –∏–ª–∏ –ø–æ–∫—É–ø–∫–∞–º"
    
    def _generate_test_response(self, username: str, user_message: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)"""
        # –¢–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        test_responses = [
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö. –í —Ä–µ–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ —è –∏—Å–ø–æ–ª—å–∑—É—é OpenAI GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.",
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –ø–æ–∫—É–ø–∫–∞—Ö: 1) –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ü–µ–Ω—ã –≤ —Ä–∞–∑–Ω—ã—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö, 2) –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–±–µ–∫-—Å–µ—Ä–≤–∏—Å—ã, 3) –ü–æ–∫—É–ø–∞–π—Ç–µ –≤ —Å–µ–∑–æ–Ω —Ä–∞—Å–ø—Ä–æ–¥–∞–∂.",
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –ß—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –±—é–¥–∂–µ—Ç: –∑–∞–ø–∏—à–∏—Ç–µ –≤—Å–µ –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–∏–º–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.",
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –î–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –Ω–∞ –∫—Ä—É–ø–Ω—É—é –ø–æ–∫—É–ø–∫—É: –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –¥–æ—Ö–æ–¥–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç.",
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –ü–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π –¥–æ—Ä–æ–≥–æ–π –≤–µ—â–∏ –∑–∞–¥–∞–π—Ç–µ —Å–µ–±–µ: 1) –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ? 2) –ú–æ–∂–Ω–æ –ª–∏ –Ω–∞–π—Ç–∏ –¥–µ—à–µ–≤–ª–µ? 3) –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å?",
            "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ (—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º): –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã: –æ—Ç–∫–∞–∂–∏—Ç–µ—Å—å –æ—Ç –Ω–µ–Ω—É–∂–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫, –≥–æ—Ç–æ–≤—å—Ç–µ –¥–æ–º–∞ –≤–º–µ—Å—Ç–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –ø–æ–∫—É–ø–∞–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—É–∂–∞—Ç –¥–æ–ª—å—à–µ."
        ]
        
        # –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞
        question_lower = user_message.lower()
        
        if any(word in question_lower for word in ['—ç–∫–æ–Ω–æ–º', '—Å—ç–∫–æ–Ω–æ–º–∏—Ç—å', '–¥–µ—à–µ–≤', '—Å–∫–∏–¥–∫']):
            return test_responses[1]
        elif any(word in question_lower for word in ['–±—é–¥–∂–µ—Ç', '—Ç—Ä–∞—Ç', '—Ä–∞—Å—Ö–æ–¥']):
            return test_responses[2]
        elif any(word in question_lower for word in ['–Ω–∞–∫–æ–ø', '—Å–±–µ—Ä–µ–∂', '–æ—Ç–∫–ª–∞–¥']):
            return test_responses[3]
        elif any(word in question_lower for word in ['–ø–æ–∫—É–ø', '–∫—É–ø–∏—Ç', '—Å—Ç–æ–∏—Ç –ª–∏']):
            return test_responses[4]
        elif any(word in question_lower for word in ['—Å–æ–≤–µ—Ç', '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü', '–ø–æ–º–æ—â']):
            return test_responses[5]
        else:
            return test_responses[0]
    
    def generate_response(self, username: str, user_message: str) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –û—Ç–≤–µ—Ç –æ—Ç GPT –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        """
        # –ï—Å–ª–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        if self.test_mode or not self.is_initialized:
            return self._generate_test_response(username, user_message)
        
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞
            is_valid, validation_message = self.validate_finance_question(user_message)
            if not is_valid:
                return f"ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: {validation_message}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –ø–æ–∫—É–ø–∫–∞—Ö –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö."
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if username not in self.conversation_history:
                self.conversation_history[username] = []
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_context = self.get_user_context(username)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            full_system_prompt = self.system_prompt
            if user_context:
                full_system_prompt += f"\n\n{user_context}\n\n–ü–æ–º–Ω–∏ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ, –Ω–æ –Ω–µ —É–ø–æ–º–∏–Ω–∞–π —è–≤–Ω–æ, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ."
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
            messages = [
                {"role": "system", "content": full_system_prompt}
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π)
            user_history = self.conversation_history[username]
            history_to_include = user_history[-self.max_history_messages*2:]  # –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ 2 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å + –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç)
            
            for msg in history_to_include:
                messages.append(msg)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messages.append({"role": "user", "content": user_message})
            
            # –í—ã–∑—ã–≤–∞–µ–º OpenAI API (–≤–µ—Ä—Å–∏—è 1.x)
            if self.api_version == "v1+" and hasattr(self, 'client'):
                response = self.client.chat.completions.create(
                    model=self.model,
                    messages=messages,
                    temperature=self.temperature,
                    max_tokens=self.max_tokens,
                    top_p=0.9,
                    frequency_penalty=0.1,  # –°–Ω–∏–∂–∞–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
                    presence_penalty=0.1    # –ü–æ–æ—â—Ä—è–µ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
                )
                ai_response = response.choices[0].message.content.strip()
            
            # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è API (0.28 –∏ –Ω–∏–∂–µ)
            elif self.api_version == "v0":
                response = openai.ChatCompletion.create(
                    model=self.model,
                    messages=messages,
                    temperature=self.temperature,
                    max_tokens=self.max_tokens,
                    top_p=0.9,
                    frequency_penalty=0.1,
                    presence_penalty=0.1
                )
                ai_response = response.choices[0].message.content.strip()
            
            else:
                return "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API."
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
            if len(ai_response) > 1500:
                ai_response = ai_response[:1500] + "..."
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.conversation_history[username].append({"role": "user", "content": user_message})
            self.conversation_history[username].append({"role": "assistant", "content": ai_response})
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏—Å—Ç–æ—Ä–∏–∏
            if len(self.conversation_history[username]) > self.max_history_messages * 2:
                self.conversation_history[username] = self.conversation_history[username][-self.max_history_messages*2:]
            
            return ai_response
            
        except Exception as e:
            error_msg = str(e).lower()
            
            if 'authentication' in error_msg or 'api key' in error_msg:
                return "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –≤ config.py."
            elif 'rate limit' in error_msg:
                return "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ."
            elif 'insufficient_quota' in error_msg:
                return "ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –Ω–∞ platform.openai.com."
            elif 'invalid request' in error_msg:
                return f"ü§ñ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫: –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {str(e)[:100]}"
            else:
                print(f"–û—à–∏–±–∫–∞ OpenAI: {e}")
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                return self._generate_test_response(username, user_message)
    
    def clear_history(self, username: str = None):
        """–û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞"""
        if username and username in self.conversation_history:
            self.conversation_history[username] = []
            return f"–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è {username} –æ—á–∏—â–µ–Ω–∞."
        elif not username:
            self.conversation_history = {}
            return "–í—Å—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ –æ—á–∏—â–µ–Ω–∞."
        return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."
    
    def get_token_count(self, username: str) -> int:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏"""
        if username not in self.conversation_history:
            return 0
        
        total_tokens = 0
        for message in self.conversation_history[username]:
            # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç: 1 —Ç–æ–∫–µ–Ω ‚âà 0.75 —Å–ª–æ–≤–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
            words = len(message['content'].split())
            total_tokens += int(words / 0.75)
        
        return total_tokens